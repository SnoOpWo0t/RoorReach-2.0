{% extends "base.html" %}
{% load static %}

{% block title %}RootReach - {{ product.name }}{% endblock %}

{% block extra_css %}
<style>
    /* Product Detail Container */
    .product-detail-container {
        margin: 40px 0;
        display: grid;
        grid-template-columns: minmax(300px, 40%) 1fr;
        gap: 40px;
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    /* Product Image Section */
    .product-image-section {
        position: relative;
    }

    .product-image {
        width: 100%;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    /* Product Info Section */
    .product-info {
        padding: 0 20px;
    }

    .product-title {
        font-size: 2rem;
        color: #000000;
        margin-bottom: 20px;
        line-height: 1.3;
    }

    .price-section {
        margin: 20px 0;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .original-price {
        text-decoration: line-through;
        color: #999;
        font-size: 1.1rem;
    }

    .discounted-price {
        font-size: 1.8rem;
        color: #e74c3c;
        font-weight: 600;
    }

    .regular-price {
        font-size: 1.8rem;
        color: var(--text-dark);
        font-weight: 600;
    }

    .stock-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 500;
        font-size: 0.9rem;
        margin: 10px 0;
    }

    .in-stock {
        background-color: #e8f5e9;
        color: #2e7d32;
    }

    .out-of-stock {
        background-color: #ffebee;
        color: #c62828;
    }

    .seller-info {
        margin: 20px 0;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .seller-info i {
        font-size: 1.2rem;
        color: var(--primary);
    }

    /* Product Actions */
    .product-actions {
        margin-top: 30px;
        display: flex;
        gap: 15px;
    }

    .product-actions .btn {
        padding: 12px 25px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
    }

    /* Tabs Section */
    .product-tabs {
        grid-column: 1 / -1;
        margin-top: 40px;
    }

    .tabs-header {
        display: flex;
        border-bottom: 2px solid #eee;
        margin-bottom: 30px;
    }

    .tab-button {
        padding: 15px 30px;
        background: none;
        border: none;
        font-size: 1rem;
        font-weight: 500;
        color: #666;
        cursor: pointer;
        position: relative;
        transition: all 0.3s ease;
    }

    .tab-button.active {
        color: var(--primary);
    }

    .tab-button.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 100%;
        height: 2px;
        background-color: var(--primary);
    }

    .tab-content {
        display: none;
        padding: 20px 0;
    }

    .tab-content.active {
        display: block;
    }

    /* Reviews Section */
    .reviews-section {
        margin-top: 20px;
    }

    .review-stats {
        display: flex;
        gap: 30px;
        margin-bottom: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .average-rating {
        text-align: center;
    }

    .average-rating .rating-number {
        font-size: 3rem;
        font-weight: 600;
        color: var(--text-dark);
        line-height: 1;
    }

    .rating-stars {
        color: #ffc107;
        font-size: 1.2rem;
        margin: 10px 0;
    }

    .review-list {
        list-style: none;
        margin: 0;
        padding: 0;
    }

    .review-item {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: grid;
        gap: 15px;
    }

    .review-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .reviewer-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .reviewer-name {
        font-weight: 500;
    }

    .review-date {
        color: #666;
        font-size: 0.9rem;
    }

    .review-content {
        color: var(--text-dark);
        line-height: 1.6;
    }

    .review-image {
        max-width: 200px;
        border-radius: 8px;
    }

    /* Review Form */
    .review-form {
        margin-top: 40px;
        background: #f8f9fa;
        padding: 30px;
        border-radius: 12px;
    }

    .review-form h4 {
        margin-bottom: 20px;
        color: var(--text-dark);
    }

    .star-rating {
        font-size: 30px;
        color: #ddd;
        cursor: pointer;
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
    }

    .star-rating .fa-star {
        transition: color 0.2s ease;
    }

    .star-rating .filled {
        color: #ffc107;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--text-dark);
    }

    .form-control {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
    }

    .form-control:focus {
        border-color: var(--primary);
        outline: none;
    }

    @media (max-width: 768px) {
        .product-detail-container {
            grid-template-columns: 1fr;
        }

        .product-info {
            padding: 0;
        }

        .review-stats {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="product-detail-container">
        <!-- Product Image -->
        <div class="product-image-section">
            <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-image">
        </div>

        <!-- Product Information -->
        <div class="product-info">
            <h1 class="product-title">{{ product.name }}</h1>

            <div class="price-section">
                {% if product.discounted_price and product.discounted_price < product.price %}
                    <span class="original-price">৳{{ product.price }}</span>
                    <span class="discounted-price">৳{{ product.discounted_price }}</span>
                {% else %}
                    <span class="regular-price">৳{{ product.price }}</span>
                {% endif %}
            </div>

            <div class="stock-badge {% if product.stock > 0 %}in-stock{% else %}out-of-stock{% endif %}">
                <i class="fas {% if product.stock > 0 %}fa-check-circle{% else %}fa-times-circle{% endif %}"></i>
                {% if product.stock > 0 %}In Stock{% else %}Out of Stock{% endif %}
            </div>

            <div class="seller-info">
                <div>
                    <i class="fas fa-user"></i>
                    <strong>Seller:</strong> {{ product.seller.username }}
                </div>
                <div>
                    <i class="fas fa-map-marker-alt"></i>
                    <strong>Region:</strong> {{ product.region }}
                </div>
            </div>

            <div class="product-actions">
                {% if product.stock > 0 and product.seller != user %}
                    <button class="btn btn-primary add-to-cart" data-product-id="{{ product.id }}" data-is-authenticated="{{ user.is_authenticated|yesno:'true,false' }}">
                        <i class="fas fa-shopping-cart"></i>
                        Add to Cart
                    </button>
                {% endif %}
                {% if product.seller != user %}
                    <a href="{% url 'product_chat' product.id %}" class="btn btn-outline chat-with-seller" data-is-authenticated="{{ user.is_authenticated|yesno:'true,false' }}">
                        <i class="fas fa-comment"></i>
                        Chat with Seller
                    </a>
                {% endif %}
            </div>
        </div>

        <!-- Tabbed Content -->
        <div class="product-tabs">
            <div class="tabs-header">
                <button class="tab-button active" data-tab="description">Description</button>
                <button class="tab-button" data-tab="specifications">Specifications</button>
                <button class="tab-button" data-tab="reviews">Reviews ({{ reviews.count }})</button>
            </div>

            <!-- Description Tab -->
            <div id="description" class="tab-content active">
                {{ product.description|linebreaks }}
            </div>

            <!-- Specifications Tab -->
            <div id="specifications" class="tab-content">
                <table class="specifications-table">
                    <!-- Add your specifications here -->
                </table>
            </div>

            <!-- Reviews Tab -->
            <div id="reviews" class="tab-content">
                <div class="reviews-section">
                    <div class="review-stats">
                        <div class="average-rating">
                            <div class="rating-number">{{ product.avg_rating|default:"0.0" }}</div>
                            <div class="rating-stars">
                                {% with avg_rating=product.avg_rating|default:0 %}
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= avg_rating %}★{% else %}☆{% endif %}
                                    {% endfor %}
                                {% endwith %}
                            </div>
                            <div>{{ reviews.count }} Reviews</div>
                        </div>
                    </div>

                    <ul class="review-list">
                        {% for review in reviews %}
                            <li class="review-item">
                                <div class="review-header">
                                    <div class="reviewer-info">
                                        <span class="reviewer-name">{{ review.reviewer.username }}</span>
                                        <div class="rating-stars">
                                            {% for i in "12345" %}
                                                {% if forloop.counter <= review.rating %}★{% else %}☆{% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <span class="review-date">{{ review.created_at|date:"F j, Y" }}</span>
                                </div>
                                <div class="review-content">{{ review.comment }}</div>
                                {% if review.image %}
                                    <img src="{{ review.image.url }}" alt="Review Image" class="review-image">
                                {% endif %}
                            </li>
                        {% empty %}
                            <li class="review-item">No reviews yet.</li>
                        {% endfor %}
                    </ul>

                    {% if user.is_authenticated and user != product.seller %}
                        <div class="review-form">
                            <h4>Write a Review</h4>
                            <form method="POST" enctype="multipart/form-data" action="{% url 'submit_review' product.id %}">
                                {% csrf_token %}
                                <div class="form-group">
                                    <label>Rating</label>
                                    <div class="star-rating" id="star-rating">
                                        {% for i in "12345" %}
                                            <i class="fa fa-star" data-value="{{ forloop.counter }}"></i>
                                        {% endfor %}
                                    </div>
                                    <input type="hidden" name="rating" id="id_rating" required>
                                </div>
                                <div class="form-group">
                                    <label for="id_comment">Your Review</label>
                                    {{ review_form.comment }}
                                </div>
                                <div class="form-group">
                                    <label for="id_image">Add Photos (Optional)</label>
                                    {{ review_form.image }}
                                </div>
                                <button type="submit" class="btn btn-primary">Submit Review</button>
                            </form>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Tab functionality
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all buttons and contents
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                // Add active class to clicked button and corresponding content
                button.classList.add('active');
                const tabId = button.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });

        // Add to Cart functionality
        const addToCartBtn = document.querySelector('.add-to-cart');
        if (addToCartBtn) {
            addToCartBtn.addEventListener('click', function(e) {
                if (this.dataset.isAuthenticated !== 'true') {
                    e.preventDefault();
                    alert("Please sign in to add items to your cart.");
                    window.location.href = "{% url 'login' %}";
                    return;
                }
                window.location.href = "{% url 'add_to_cart' product.id %}";
            });
        }

        // Chat with Seller functionality
        const chatBtn = document.querySelector('.chat-with-seller');
        if (chatBtn) {
            chatBtn.addEventListener('click', function(e) {
                if (this.dataset.isAuthenticated !== 'true') {
                    e.preventDefault();
                    alert("Please sign in to chat with the seller.");
                    window.location.href = "{% url 'login' %}";
                    return;
                }
            });
        }

        // Rating stars functionality
        const stars = document.querySelectorAll('.star-rating .fa-star');
        const hiddenInput = document.getElementById('id_rating');

        stars.forEach((star, index) => {
            star.addEventListener('click', function() {
                const rating = index + 1;
                hiddenInput.value = rating;
                updateStars(rating);
            });

            star.addEventListener('mouseover', function() {
                updateStars(index + 1);
            });

            star.addEventListener('mouseout', function() {
                const currentRating = parseInt(hiddenInput.value) || 0;
                updateStars(currentRating);
            });
        });

        function updateStars(rating) {
            stars.forEach((s, i) => {
                s.classList.toggle('filled', i < rating);
            });
        }

        // If form re-renders after error, restore rating
        const currentRating = parseInt(hiddenInput.value);
        if (currentRating) {
            updateStars(currentRating);
        }
    });
</script>
{% endblock %}
